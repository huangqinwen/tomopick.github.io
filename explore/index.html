
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://huangqinwen.github.io/tomopick.github.io/explore/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../refine/">
      
      
      <link rel="icon" href="../assets/milopyp_icon_only_large.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.34">
    
    
      
        <title>Cellular Content Exploration - </title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.35f28582.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
  
  <style>:root{--md-admonition-icon--<type>:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14h-2V9h2m0 9h-2v-2h2M1 21h22L12 2z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cellular-content-exploration-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="" class="md-header__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../assets/milopyp_large.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cellular Content Exploration
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href=".." class="md-tabs__link">
          
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="" class="md-nav__button md-logo" aria-label="" data-md-component="logo">
      
  <img src="../assets/milopyp_large.png" alt="logo">

    </a>
    
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href=".." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cellular Content Exploration
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cellular Content Exploration
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cellular-content-exploration-module" class="md-nav__link">
    <span class="md-ellipsis">
      Cellular content exploration module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cellular content exploration module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#input-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Input preparation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    <span class="md-ellipsis">
      Training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-visualization-plot" class="md-nav__link">
    <span class="md-ellipsis">
      2D visualization plot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-tomogram-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      3D Tomogram visualization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-interactive-session" class="md-nav__link">
    <span class="md-ellipsis">
      3D interactive session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-exported-parquet-files-to-training-coordinates-file-for-refinement-module" class="md-nav__link">
    <span class="md-ellipsis">
      Convert exported parquet files to training coordinates file for refinement module
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../refine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Particle Refined Localization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quick_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cellular-content-exploration-module" class="md-nav__link">
    <span class="md-ellipsis">
      Cellular content exploration module
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cellular content exploration module">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#input-preparation" class="md-nav__link">
    <span class="md-ellipsis">
      Input preparation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    <span class="md-ellipsis">
      Training
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inference" class="md-nav__link">
    <span class="md-ellipsis">
      Inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2d-visualization-plot" class="md-nav__link">
    <span class="md-ellipsis">
      2D visualization plot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-tomogram-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      3D Tomogram visualization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-interactive-session" class="md-nav__link">
    <span class="md-ellipsis">
      3D interactive session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-exported-parquet-files-to-training-coordinates-file-for-refinement-module" class="md-nav__link">
    <span class="md-ellipsis">
      Convert exported parquet files to training coordinates file for refinement module
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Cellular Content Exploration</h1>

<h2 id="cellular-content-exploration-module">Cellular content exploration module<a class="headerlink" href="#cellular-content-exploration-module" title="Permanent link">&para;</a></h2>
<p>For the exploration step, MiLoPYP learns an embedding space for 3D macromolecules such that similar structures are grouped together while dissimilar ones are separated. The embedding space is then projected into 2D and 3D which allows easy identification of the distribution of macromolecular structures across an entire dataset. </p>
<h3 id="input-preparation">Input preparation<a class="headerlink" href="#input-preparation" title="Permanent link">&para;</a></h3>
<p>There are two different mode for this module: </p>
<p><code>2d3d</code>: Input to this module include aligned 2D tilt series (.mrc, or .ali as in <code>sample_data</code>), corresponding angles (.tlt), 3D reconstructed tomograms from tilt series (.rec). </p>
<p><code>3d</code>: Input to this module is 3D reconstructed tomograms(.rec) alone. </p>
<p>For <code>2d3d</code> mode, the training file should be a <code>.txt</code> file with tomogram name, path to 2D tilt series, path to corresponding angles, path to 3D reconstructed tomograms in the following format: </p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>image_name   rec_path    tilt_path   angle_path  
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>tomo1   path_to_rec_1   path_to_tilt_1   path_to_angle_1
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>tomo2   path_to_rec_2   path_to_tilt_2   path_to_angle_2
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>...
</span></code></pre></div>
<p>For example, suppose we store tilt series, corresponding angles, and reconstructed tomograms to the data directory with path: <code>/data</code>, the training txt file will look like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>image_name   rec_path    tilt_path   angle_path  
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>tomo1   sample_data/tomo1.rec   sample_data/tomo1.mrc   sample_data/tomo1.tlt
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>tomo2   sample_data/tomo2.rec   sample_data/tomo1.mrc   sample_data/tomo1.tlt
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>...
</span></code></pre></div>
<p>For <code>3d</code> mode, the training txt file only need <code>rec_path</code> and tomogram name. <code>tilt_path</code> and <code>angle_path</code> are not needed. Therefore, the file will have the following format: </p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>image_name   rec_path     
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>tomo1   path_to_rec_1   
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>tomo2   path_to_rec_2   
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>...
</span></code></pre></div>
It is also ok to use the same file formatted for <code>2d3d</code> mode. Only <code>rec_path</code> will be used. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure the 2D tilt seires are aligned tilt series. It also needs to be the same <code>x-y</code> dimension as 3D tomogram. Typically we recommend using downsampled tilt series and 3D tomograms (with x-y dimension less than 2000px)</p>
</div>
<p><strong>Once files are generated, move all training files to <code>data/</code> directory (create <code>data/</code> directory if it doesn't exist)</strong></p>
<h3 id="training">Training<a class="headerlink" href="#training" title="Permanent link">&para;</a></h3>
<p>To train exploration module in 2d3d mode (with tilt series and tomograms), run:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>python simsiam_main.py simsiam2d3d --num_epochs 300 --exp_id test_sample --bbox 36 --dataset simsiam2d3d --arch simsiam2d3d_18 --lr 1e-3 --train_img_txt sample_train_explore_img.txt --batch_size 256 --val_intervals 20 --save_all --gauss 0.8 --dog 3,5
</span></code></pre></div>
For <code>2d3d</code> mode, training-related files will be saved to <code>exp/simsiam2d3d/test_sample</code>, including log file with loss and all used arguments. </p>
<p>To train exploration module in 3d mode (using tomogram only), run:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>python simsiam_main.py simsiam3d --num_epochs 300 --exp_id test_sample --bbox 36 --dataset simsiam3d --arch simsiam2d_18 --lr 1e-3 --train_img_txt sample_train_explore_img.txt --batch_size 256 --val_intervals 20 --save_all --gauss 0.8 --dog 3,5
</span></code></pre></div>
For <code>3d</code> mode, training-related files will be saved to <code>exp/simsiam3d/test_sample</code>, including log file with loss and all used arguments. </p>
<table>
<thead>
<tr>
<th style="text-align: left;">Arguments</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>num_epochs</code></td>
<td style="text-align: left;">number of training epochs, recommend 100 to 300</td>
</tr>
<tr>
<td style="text-align: left;"><code>exp_id</code></td>
<td style="text-align: left;">experiment id you want to save it as.</td>
</tr>
<tr>
<td style="text-align: left;"><code>bbox</code></td>
<td style="text-align: left;">bounding box size for cropped patches, should bigger than particles</td>
</tr>
<tr>
<td style="text-align: left;"><code>dataset</code></td>
<td style="text-align: left;">sampling and dataloader mode</td>
</tr>
<tr>
<td style="text-align: left;"><code>arch</code></td>
<td style="text-align: left;">model backbone architecture</td>
</tr>
<tr>
<td style="text-align: left;"><code>lr</code></td>
<td style="text-align: left;">learning rate</td>
</tr>
<tr>
<td style="text-align: left;"><code>training_img_txt</code></td>
<td style="text-align: left;">input txt for training</td>
</tr>
<tr>
<td style="text-align: left;"><code>batch_size</code></td>
<td style="text-align: left;">batch size for training</td>
</tr>
<tr>
<td style="text-align: left;"><code>val_intervals</code></td>
<td style="text-align: left;">save model every val_intervals</td>
</tr>
<tr>
<td style="text-align: left;"><code>save_all</code></td>
<td style="text-align: left;">whether to save all models for each val_interval</td>
</tr>
<tr>
<td style="text-align: left;"><code>gauss</code></td>
<td style="text-align: left;">preprocessing gaussian filter to denoise tilt series and tomogram</td>
</tr>
<tr>
<td style="text-align: left;"><code>dog</code></td>
<td style="text-align: left;">kernel sizes for difference of gaussian pyramid, comma delimited</td>
</tr>
</tbody>
</table>
<p>For more information regarding arguments, go to <code>opts.py</code></p>
<h3 id="inference">Inference<a class="headerlink" href="#inference" title="Permanent link">&para;</a></h3>
<p>After training, to map tomograms/tilt series into embeddings, use trained model to perform mapping.</p>
<p>For <code>2d3d</code> mode, run: 
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>python simsiam_test_hm_2d3d.py simsiam2d3d --exp_id test_sample --bbox 36 --dataset simsiam2d3d --arch simsiam2d3d_18 --test_img_txt sample_train_explore_img.txt --load_model exp/simsiam2d3d/test_sample/model_300.pth --gauss 0.8 --dog 3,5
</span></code></pre></div></p>
<p>For <code>3d</code> mode, run:</p>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>python simsiam_test_hm_3d.py simsiam3d --exp_id test_sample --bbox 36 --dataset simsiam3d --arch simsiam2d_18 --test_img_txt sample_train_explore_img.txt --load_model exp/simsiam3d/test_sample/model_300.pth --gauss 0.8 --dog 3,5
</span></code></pre></div>
Here we are using trained model from 300<sup>th</sup> epoch. </p>
<details class="tip" open="open">
<summary>Note: Please make sure to use same architecture, bounding box size, gauss, and dog argument for both training and inference and select proper trained model</summary>
<p>For example, if use <code>--bbox 36 --gauss 0.8 --dog 3,5</code> in training arguments, make sure the same arguments are used for inference. 
To find used arguments for training, go to the output folder and check <code>opts.txt</code>.
For trained model selection, check loss in <code>log.txt</code> and select models with lower loss. </p>
</details>
<p>Inference output is a npz file that contains embeddings, corresponding coordinates, original cropped patches from tomogram, names of corresponding tomogram. Output is saved to <code>exp/simsiam2d3d/test_sample/all_output_info.npz</code> for <code>2d3d</code> mode and <code>exp/simsiam3d/test_sample/all_output_info.npz</code>for 3d mode. </p>
<h3 id="2d-visualization-plot">2D visualization plot<a class="headerlink" href="#2d-visualization-plot" title="Permanent link">&para;</a></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="2d-visualization-plot-2d-visualization-plot" name="__tabbed_1" type="radio" /><input id="2d-visualization-plot-2d-visualization-with-labels" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="2d-visualization-plot-2d-visualization-plot">2D visualization plot</label><label for="2d-visualization-plot-2d-visualization-with-labels">2D visualization with labels</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="../assets/test_10304_oc_umap3_3d_small.png"><img alt="2D visualization plot" src="../assets/test_10304_oc_umap3_3d_small.png" /></a></p>
</div>
<div class="tabbed-block">
<p><a href="../assets/2d_vis_with_label.png"><img alt="2D visualization with labels" src="../assets/2d_vis_with_label.png" /></a></p>
</div>
</div>
</div>
<p>To generate 2D visualization plot, run:
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>python plot_2d.py --input exp/simsiam2d3d/test_sample/all_output_info.npz --n_cluster 48 --num_neighbor 40 --mode umap --path exp/simsiam2d3d/test_sample/ --min_dist_vis 1.3e-3 
</span></code></pre></div>
2D visualization plot will be saved to <code>exp/simsiam2d3d/test_sample/2d_visualization_out.png</code> and an additional visualization plot with labels generated using over-clustering algorithm <code>exp/simsiam2d3d/test_sample/2d_visualization_labels.png</code>, in the same directory, additional outputs include <code>all_colors.npy</code> that will be used as input for 3D tomogram visualization plotting and <code>interactive_info_parquet.gzip</code> that includes labels from overclustering and is used as input for interactive session. PNGs of all cropped patches will be also saved to <code>exp/simsiam2d3d/test_sample/imgs/</code> folder. This will later be used for interactive session. For <code>3d</code> mode, replace <code>simsiam2d3d</code> with <code>simsiam3d</code>.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Arguments</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>input</code></td>
<td style="text-align: left;">output all_output_info.npz from inference</td>
</tr>
<tr>
<td style="text-align: left;"><code>n_cluster</code></td>
<td style="text-align: left;">number of clusters for overclustering</td>
</tr>
<tr>
<td style="text-align: left;"><code>num_neighbor</code></td>
<td style="text-align: left;">number of neighbors for both tsne and umap clustering</td>
</tr>
<tr>
<td style="text-align: left;"><code>mode</code></td>
<td style="text-align: left;">whether to use tsne or umap for dimensionality reduction</td>
</tr>
<tr>
<td style="text-align: left;"><code>path</code></td>
<td style="text-align: left;">path of directory to save all output and images</td>
</tr>
<tr>
<td style="text-align: left;"><code>host</code></td>
<td style="text-align: left;">local host for images, default is 7000</td>
</tr>
<tr>
<td style="text-align: left;"><code>min_dist_umap</code></td>
<td style="text-align: left;">min distance in UMAP</td>
</tr>
<tr>
<td style="text-align: left;"><code>min_dist_vis</code></td>
<td style="text-align: left;">min distance for patch display on2d visualization</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<h3 id="3d-tomogram-visualization">3D Tomogram visualization<a class="headerlink" href="#3d-tomogram-visualization" title="Permanent link">&para;</a></h3>
<p><a href="../assets/3d_vis.png"><img alt="3D visualization plot" src="../assets/3d_vis.png" /></a></p>
<p>To generate 3D tomogram visualization plot, run:
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>python visualize_3dhm.py --input exp/simsiam2d3d/test_sample/all_output_info.npz --color exp/simsiam2d3d/test_sample/all_colors.npy --dir_simsiam exp/simsiam2d3d/test_sample/ --rec_dir sample_data/
</span></code></pre></div>
Outputs include two numpy arrays: <code>*rec3d.npy</code> is the numpy array for 3D tomogram and <code>*hm3d_simsiam.npy</code> is  the numpy array for color heatmaps. To generate example visualization plot, two arrays can be </p>
<ol>
<li>
<p>loaded using <a href="https://napari.org/stable/">napari</a> as two layers and transparency of each layer can be adjusted in the napari interface</p>
</li>
<li>
<p>blending two arrays by weighted averaging <code>w x rec_3d.npy + (1-w) x hm3d_simsiam.npy</code> and the resulting array will be the 3D tomogram visualization with color. </p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align: left;">Arguments</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>input</code></td>
<td style="text-align: left;">output all_output_info.npz from inference</td>
</tr>
<tr>
<td style="text-align: left;"><code>color</code></td>
<td style="text-align: left;">.npy color array, generated by plot_2d.py</td>
</tr>
<tr>
<td style="text-align: left;"><code>dir_simsiam</code></td>
<td style="text-align: left;">directory to the current run</td>
</tr>
<tr>
<td style="text-align: left;"><code>rec_dir</code></td>
<td style="text-align: left;">path to directory with corresponding rec file</td>
</tr>
</tbody>
</table>
<p>For <code>3d</code> mode, replace <code>simsiam2d3d</code> with <code>simsiam3d</code>.</p>
<h3 id="3d-interactive-session">3D interactive session<a class="headerlink" href="#3d-interactive-session" title="Permanent link">&para;</a></h3>
<p>Interactive session requires loading of local images (which are already generated by <code>plot_2d.py</code>). Local images are generated by <code>plot_2d.py</code> under directory <code>exp/simsiam2d3d/test_sample/imgs/</code>. To connect images to local host and keep it running in the background, initiate a new screen session in terminal with <code>screen</code>, go to <code>exp/simsiam2d3d/test_sample/</code> and run <code>python -m http.server 7000</code>. The images will be hosted on <code>7000</code>. Detach the screen session. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure to use the same number as the <code>host</code> argument in <code>plot_2d.py</code>, default is 7000. </p>
</div>
<p>To initiate interactive session, run:
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>python phoenix_visualization.py --input exp/simsiam2d3d/test_sample/interactive_info_parquet.gzip
</span></code></pre></div>
On terminal, it should show headers of parquet file, including local host address for interactive session. For example, here the local host address is <code>http://localhost:33203/</code>
<a href="../assets/interactive_p1.jpg"><img alt="interactive session terminal display" src="../assets/interactive_p1.jpg" /></a></p>
<p>You should now be able to access the interactive session at <code>http://localhost:33203/</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you are running everything on a remote cluster and want to visualize everything through local browser, you will first need to connect remote to local. This needs to be done for both images and the interactive session. To connect images with local host 7000, use <code>ssh -N -f -L localhost:7000:localhost:7000 your_remote_login_address</code> on local terminal. To connect interactive session with local host 33203, use  <code>ssh -N -f -L localhost:33203:localhost:33203 your_remote_login_address</code>.</p>
</div>
<p>In the interactive session, you should be able to visualize clusters of 3D embeddings, you will be able to adjust the number of points to be displayed in the cluster, coloring of each embedding based on label, select subclusters based on labels, and export selected subclusters. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="3d-interactive-session-homepage-for-interactive-session" name="__tabbed_2" type="radio" /><input id="3d-interactive-session-adjust-number-of-points-to-be-displayed" name="__tabbed_2" type="radio" /><input id="3d-interactive-session-coloring-of-embeddings-based-on-labels" name="__tabbed_2" type="radio" /><input id="3d-interactive-session-select-and-export-subclusters-based-on-labels" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="3d-interactive-session-homepage-for-interactive-session">homepage for interactive session</label><label for="3d-interactive-session-adjust-number-of-points-to-be-displayed">adjust number of points to be displayed</label><label for="3d-interactive-session-coloring-of-embeddings-based-on-labels">coloring of embeddings based on labels</label><label for="3d-interactive-session-select-and-export-subclusters-based-on-labels">select and export subclusters based on labels</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="../assets/interactive_2.jpg"><img alt="homepage for interactive session" src="../assets/interactive_2.jpg" /></a></p>
</div>
<div class="tabbed-block">
<p><a href="../assets/interactive_3.jpg"><img alt="adjust number of points to be displayed" src="../assets/interactive_3.jpg" /></a></p>
</div>
<div class="tabbed-block">
<p><a href="../assets/interactive_4.jpg"><img alt="coloring of embeddings based on labels" src="../assets/interactive_4.jpg" /></a></p>
</div>
<div class="tabbed-block">
<p><a href="../assets/interactive_5.jpg"><img alt="select and export subclusters based on labels" src="../assets/interactive_5.jpg" /></a></p>
</div>
</div>
</div>
<h3 id="convert-exported-parquet-files-to-training-coordinates-file-for-refinement-module">Convert exported parquet files to training coordinates file for refinement module<a class="headerlink" href="#convert-exported-parquet-files-to-training-coordinates-file-for-refinement-module" title="Permanent link">&para;</a></h3>
<p>Exported coordinates can be downloaded through interactive session. In the example below, the downloaded parquet is named as <code>2023-10-08_19-44-41.parquet</code>.</p>
<p><a href="../assets/interactive_6.jpg"><img alt="dowloand exported coordinates" src="../assets/interactive_6.jpg" /></a></p>
<p>Convert parquet to training coordinates <code>.txt</code> files by running:
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>python interactive_to_training_coords.py --input path_to_dir_of_parquets --output training_coordinates.txt 
</span></code></pre></div></p>
<table>
<thead>
<tr>
<th style="text-align: left;">Arguments</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>input</code></td>
<td style="text-align: left;">full path to directory that contains all downloaded parquet file</td>
</tr>
<tr>
<td style="text-align: left;"><code>output</code></td>
<td style="text-align: left;">full path to output training coordinates file</td>
</tr>
<tr>
<td style="text-align: left;"><code>if_double</code></td>
<td style="text-align: left;">whether z coordinates obtained from DoGs in exploration module is downscaled by 2, if so needs to rescale it back</td>
</tr>
</tbody>
</table>
<p><strong>Now, we can using the same training image file <code>sample_train_explore_img.txt</code> and the generated trainning coordinates file <code>training_coordinates.txt</code> for the subsequent refinement module.</strong></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Installation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Installation
              </div>
            </div>
          </a>
        
        
          
          <a href="../refine/" class="md-footer__link md-footer__link--next" aria-label="Next: Particle Refined Localization">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Particle Refined Localization
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.07f07601.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>